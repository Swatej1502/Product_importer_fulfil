<!DOCTYPE html>
<html>
<head>
  <title>Webhook Management</title>

  <style>
    body { font-family: Arial, sans-serif; }
    table { border-collapse: collapse; margin-top: 10px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    input, select, button { margin: 4px; }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 3px solid #ccc;
      border-top: 3px solid #333;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    .hidden { display: none; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>

<body>

<a href="/">← Back to Products</a>

<h2>Webhook Management</h2>

<!-- ================= CREATE / EDIT FORM ================= -->

<h3 id="formTitle">Create Webhook</h3>

<input id="urlInput" placeholder="Webhook URL" size="50"><br>

<select id="eventInput">
  <option value="import_completed">Import Completed</option>
  <option value="product_created">Product Created</option>
  <option value="product_updated">Product Updated</option>
  <option value="product_deleted">Product Deleted</option>
  <option value="bulk_deleted">Bulk Deleted</option>
</select>

<label>
  Enabled <input type="checkbox" id="enabledInput" checked>
</label><br>

<button onclick="saveWebhook()">Save</button>
<button onclick="resetForm()">Cancel</button>

<p id="formStatus"></p>

<hr>

<!-- ================= WEBHOOK TABLE ================= -->

<h3>Configured Webhooks</h3>

<span id="loadSpinner" class="spinner hidden"></span>

<table>
  <thead>
    <tr>
      <th>URL</th>
      <th>Event</th>
      <th>Enabled</th>
      <th>Last Test Result</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

<script>
/* ================= GLOBAL STATE ================= */

let editingId = null;
let webhookCache = {};

/* ================= LOAD WEBHOOKS ================= */

function loadWebhooks() {
  loadSpinner.classList.remove("hidden");

  fetch("/webhooks/")
    .then(r => r.json())
    .then(data => {
      rows.innerHTML = "";
      webhookCache = {};

      for (let i = 0; i < data.length; i++) {
        let w = data[i];
        webhookCache[w.id] = w;

        let result = "-";
        if (w.last_test_status) {
          result = w.last_test_status + " (" + w.last_test_time_ms + " ms)";
        } else if (w.last_test_error) {
          result = "❌ " + w.last_test_error;
        }

        rows.innerHTML +=
          "<tr>" +
            "<td>" + w.url + "</td>" +
            "<td>" + w.event_type + "</td>" +
            "<td>" + w.enabled + "</td>" +
            "<td>" + result + "</td>" +
            "<td>" +
              "<button onclick='editWebhook(" + w.id + ")'>Edit</button> " +
              "<button onclick='testWebhook(" + w.id + ")'>Test</button> " +
              "<button onclick='deleteWebhook(" + w.id + ")'>Delete</button>" +
            "</td>" +
          "</tr>";
      }
    })
    .catch(() => alert("Failed to load webhooks"))
    .finally(() => loadSpinner.classList.add("hidden"));
}

/* ================= CREATE / UPDATE ================= */

function saveWebhook() {
  if (!urlInput.value) {
    alert("Webhook URL is required");
    return;
  }

  let payload = {
    url: urlInput.value,
    event_type: eventInput.value,
    enabled: enabledInput.checked
  };

  let url = "/webhooks/create/";
  if (editingId) {
    url = "/webhooks/update/" + editingId + "/";
  }

  formStatus.innerText = "Saving...";

  fetch(url, {
    method: "POST",
    body: JSON.stringify(payload)
  })
    .then(() => {
      formStatus.innerText = "✅ Saved";
      resetForm();
      loadWebhooks();
    })
    .catch(() => {
      formStatus.innerText = "❌ Failed";
    });
}

/* ================= EDIT ================= */

function editWebhook(id) {
  let w = webhookCache[id];
  if (!w) return;

  editingId = id;
  formTitle.innerText = "Edit Webhook";
  urlInput.value = w.url;
  eventInput.value = w.event_type;
  enabledInput.checked = w.enabled;
}

/* ================= DELETE ================= */

function deleteWebhook(id) {
  if (!confirm("Delete this webhook?")) return;

  fetch("/webhooks/delete/" + id + "/", { method: "POST" })
    .then(loadWebhooks)
    .catch(() => alert("Delete failed"));
}

/* ================= TEST ================= */

function testWebhook(id) {
  let rowMsg = document.createElement("span");
  rowMsg.innerText = " Testing...";
  rows.appendChild(rowMsg);

  fetch("/webhooks/test/" + id + "/", { method: "POST" })
    .then(() => {
      alert("Webhook test triggered.\nRefresh to see result.");
    })
    .catch(() => alert("Test failed"));
}

/* ================= RESET ================= */

function resetForm() {
  editingId = null;
  formTitle.innerText = "Create Webhook";
  urlInput.value = "";
  enabledInput.checked = true;
  formStatus.innerText = "";
}

/* ================= INITIAL LOAD ================= */

loadWebhooks();
</script>

</body>
</html>
