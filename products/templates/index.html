<!DOCTYPE html>
<html>
<body>
<h2>CSV Upload</h2>

<input type="file" id="file">
<button onclick="upload()">Upload</button>

<p id="progress"></p>

<button onclick="load()">Load Products</button>
<button onclick="clearAll()">Delete All</button>

<pre id="data"></pre>

<script>
function upload() {
  let fd = new FormData();
  fd.append("file", file.files[0]);

  fetch("/imports/upload/", { method:"POST", body:fd })
    .then(r=>r.json())
    .then(d=>track(d.job_id));
}

function track(id) {
  let t = setInterval(()=>{
    fetch(`/imports/status/${id}/`)
      .then(r=>r.json())
      .then(d=>{
        progress.innerText = `${d.status}: ${d.processed}/${d.total}`;
        if (d.status === "COMPLETED" || d.status === "FAILED")
          clearInterval(t);
      });
  }, 1000);
}

function load() {
  fetch("/products/")
    .then(r=>r.json())
    .then(d=>data.innerText = JSON.stringify(d,null,2));
}

function clearAll() {
  if (!confirm("Delete all products?")) return;
  fetch("/products/delete-all/")
    .then(()=>alert("Deleted"));
}
</script>
</body>
</html>
